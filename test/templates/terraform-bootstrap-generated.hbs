###############################################################################
###############################################################################
####                                                                       ####
####              THIS FILE WAS GENERATED WITH METASTRUCTURE               ####
####                       DO NOT EDIT IT MANUALLY!                        ####
####                                                                       ####
###############################################################################
###############################################################################

{{#each organizational_units}}{{#if (lodash "eq" this.action "remove")}}
###############################################################################
# Remove organizational unit "{{this.name}}".
###############################################################################
removed {
  from       = aws_organizations_organizational_unit.organizational_units["{{@key}}"]
  lifecycle {
    destroy = false
  }
}
{{/if}}{{/each}}{{#each accounts}}{{#if (lodash "eq" this.action "remove")}}
###############################################################################
# Remove account "{{this.name}}".
###############################################################################
removed {
  from       = aws_organizations_account.accounts["{{@key}}"]
  lifecycle {
    destroy = false
  }
}
{{/if}}
{{#if (logic "or" (lodash "eq" this.action "destroy") (lodash "eq" this.action "remove"))}}
###############################################################################
# Remove Terraform deployment role from account "{{this.name}}".
###############################################################################
removed {
  from      = module.terraform_deployment_role_{{@key}}
  lifecycle {
    destroy = false
  }
}
{{else}}
###############################################################################
# Create a Terraform deployment role at account "{{this.name}}"
# and allow it to be assumed from the master account.
###############################################################################
module "terraform_deployment_role_{{@key}}" {
  source = "../modules/delegated-role"
  providers = {
    aws = aws.{{@key}}
  }
  delegated_policy_arns  = ["arn:aws:iam::aws:policy/AdministratorAccess"]
  delegator_principals   = ["${aws_organizations_account.accounts["{{../organization.master_account}}"].id}"]
  delegated_role_name    = module.global.config.terraform.roles.deployment
}
{{/if}}{{/each}}
