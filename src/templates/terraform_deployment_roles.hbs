###############################################################################
# This file is generated via `nr cli config`. Do not edit it manually!
###############################################################################

{{#each accounts}}
###############################################################################
# Create a provider to assume the OrganizationAccountAccessRole role on the 
# {{this.name}}.
###############################################################################
provider "aws" {
  alias = "assume_{{@key}}"

  assume_role {
    role_arn = "arn:aws:iam::${aws_organizations_account.accounts.{{@key}}.id}:role/OrganizationAccountAccessRole"
  }

  region = module.global.config.organization.aws_region
}

###############################################################################
# Create a Terraform deployment role based on the {{this.name}}
# and allow it to be assumed by the Terraform state account.
###############################################################################
module "{{../terraform.state_account}}_assume_{{@key}}_terraform_deployment_role" {
  source   = "../../modules/cross-account-role"
  providers = {
    aws = aws.assume_{{@key}}
  }
  assume_role_policy_json = data.aws_iam_policy_document.crossaccount_assume_from_terraform_state_account.json
  role_name               = module.global.config.terraform.deployment_role
  role_policy_arn         = "arn:aws:iam::aws:policy/AdministratorAccess"
}

{{/each}}